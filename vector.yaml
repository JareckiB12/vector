api:
  enabled: true
  address: 0.0.0.0:8686
  playground: true

sources:
  docker:
    type: docker_logs
  
  internal_metrics:
    type: internal_metrics

transforms:
  # Filtruj logi zawierające "hello-world"
  filter_hello_world:
    type: filter
    inputs:
      - docker
    condition:
      type: vrl
      source: contains(string!(.message), "hello-world")
  
  # Zlicz przefiltrowane logi jako metrykę
  hello_world_counter:
    type: log_to_metric
    inputs:
      - filter_hello_world
    metrics:
      - type: counter
        field: message
        name: hello_world_occurrences_total
        # namespace: custom # dodaje taki przedrostek do metryki
  
  # Przekształć dane dla OpenSearch aby uniknąć konfliktów
  opensearch_prep:
    type: remap
    inputs:
      - docker
    source: |
      # Usuń zagnieżdżone labele, które powodują konflikty
      if exists(.label) {
        del(.label)
      }

sinks:
  console:
    inputs:
      - docker
    type: console
    encoding:
      codec: json
  
  prometheus_exporter:
    type: prometheus_exporter
    inputs:
      - internal_metrics
      - hello_world_counter
    address: 0.0.0.0:9598

  minio:
    type: aws_s3
    inputs:
      - docker
    bucket: logs
    endpoint: http://minio:9000
    region: us-east-1
    auth:
      access_key_id: minioadmin
      secret_access_key: minioadmin
    encoding:
      codec: json

  opensearch:
    type: elasticsearch
    inputs:
      - opensearch_prep
    endpoints:
      - http://opensearch:9200
    api_version: v8
    mode: bulk
    bulk:
      index: "logs-%Y-%m-%d"
